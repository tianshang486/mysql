# SQL Server备份数据恢复上云

您可以通过DBS推出的**迁移任务**功能将线下或ECS自建SQL Server数据库无缝迁移上云。基于**迁移任务**功能，SQL Server备份迁移上云速度快且稳定。

-   您已在源实例所在的设备上添加备份网关，详情请参见[添加备份网关](~~93250~~)。
-   您已开通对象存储OSS（Object Storage Service）服务，详情请参见[开通OSS服务](/cn.zh-CN/快速入门/开通OSS服务.md)。
-   源SQL Server数据库版本为2005、2008、2008 R2、2012、2014、2016或2017。

    **说明：**

    您可以通过DBS将源实例迁移至已创建的RDS SQL Server实例中，同时您也可以在DBS迁移任务中选择**新建实例**，系统会根据您的源库版本自动创建对应兼容版本的RDS SQL Server实例。

    为版本兼容性，源库版本号对应的RDS SQL Server版本如下：

    |源数据库版本号|目标RDS SQL Server版本|
    |-------|------------------|
    |SQL Server 2005 ~ 2012|RDS SQL Server 2012企业版|
    |SQL Server 2014 ~ 2016|RDS SQL Server 2016企业版|
    |SQL Server 2017|RDS SQL Server 2017企业版|


相比传统逻辑上云，通过DBS备份SQL Server迁移上云具有以下优点：

-   速度快：传统逻辑上云是通过JDBC（Java Database Connectivity）方式将数据全量上传至RDS上，性能受限于JDBC的查询性能。而DBS提供的物理备份迁移上云的方式，将已备份的物理数据并复制到RDS中，速度更快。
-   增量迁移成功率高：如果通过增量逻辑（SQL Server Redo log）的方式迁移上云，由于增量Redo log格式闭源，解析Redo log的方式错误率比较高。如果通过增量备份恢复的方式迁移上云，调用SQL Server的原生接口，成功率会更高。
-   易操作：DBS将源库信息、备份目标信息、目标RDS信息都整合至[配置任务计划](#section_c3m_fsu_45q)步骤中，且界面简单易操作，您仅需在该步骤完成一次参数配置即可。

## 注意事项

-   迁移成功的RDS SQL Server实例暂不支持修改数据库名称。
-   现仅支持创建按量付费的DBS实例。

## 费用说明

-   DBS备份费用：现仅支持创建按量付费的DBS计划，详情可参见[备份费用]()。
-   OSS费用：需要支付备份产生的OSS费用，详情请参见[对象存储OSS计费说明](~~59636~~)
-   RDS SQL Server费用：系统会根据您选择的规格与存储空间大小进行收费，详情请参见[云产品定价](https://www.aliyun.com/price/product?spm=a2c4g.11186623.2.15.7cf82c6cB7e84X#/rds/detail)。

    **说明：** DBS创建的RDS SQL Server为按量付费。


## 创建迁移任务

1.  登录[DBS控制台](https://dbs.console.aliyun.com/)。

2.  单击左侧导航栏中的**备份数据恢复上云** \> **SQL Server**。

3.  单击右上角**创建迁移任务**按钮。

4.  设置如下参数，单击**立即购买**。

    ![创建迁移任务界面](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5132269951/p162855.png)

    |配置项|说明|
    |---|--|
    |**DBS地域**|选择DBS实例所在的地域。**说明：** 请与OSS的地域保持一致。 |
    |**备份方式**|默认选择**物理备份**。|
    |**数据库类型**|默认选择**SQL Server**。|
    |**付费类型**|默认选择**按量付费**。**说明：** 暂不支持**包年包月**。 |


## 配置任务计划

1.  登录[DBS控制台](https://dbs.console.aliyun.com/)。

2.  单击左侧导航栏中的**备份数据恢复上云** \> **SQL Server**。

3.  单击目标迁移任务右侧**操作**列下的**配置备份计划**。

    ![配置迁移任务按钮](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5132269951/p162928.png)

4.  在**配置备份源和目标**页面，配置相关信息并单击**下一步**。

    ![配置迁移任务](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2819420061/p162946.png)

    |类别|配置|说明|
    |--|--|--|
    |**备份源信息**|**备份方式**|默认选择物理备份。|
    |**实例地区**|选择源实例所在地区。|
    |**备份网关**|选择目标备份网关，更多关于添加备份网关的说明请参见[添加备份网关](~~93250~~)。|
    |**数据库类型**|默认选择SQL Server数据库。|
    |**连接地址**|目标数据库的连接地址，默认为localhost。|
    |**端口**|目标数据库的连接端口，默认为1433。|
    |**备份目标信息**|**备份目标存储类型**|请选择**用户OSS**。|
    |**对象存储OSS Bucket名称**|选择目标OSS实例。|
    |**存储方式**|存储方式，支持：    -   非加密存储
    -   内置加密存储
    -   KMS加密存储 |
    |**恢复目标数据库**|**目标数据库实例类型**|您可以按需选择**新建实例**或**使用已有实例**，本案例以**新建实例**进行介绍。**说明：** 若您选择**使用已有实例**，您还需配置**数据库所在位置**、**实例地区**、**RDS实例ID**参数，各参数的介绍请看下表。 |
    |**数据库所在位置**|默认选择RDS实例。|
    |**实例地区**|可根据目标实例地域或您的业务所在地就近选择，可以降低访问数据库的延迟。|
    |**VPC**|选择目标VPC。|
    |**实例规格**|默认选择4核16GB，支持8核32GB、16核64GB、32核128GB规格，费用请参见[云产品定价](https://www.aliyun.com/price/product?spm=a2c4g.11186623.2.15.7cf82c6cB7e84X#/rds/detail)。|
    |**存储空间**|默认选择500GB，请按需选择。|
    |**RDS实例ID**|选择您的目标RDS实例ID。**说明：** 该选项仅在**目标数据库实例类型**选择**使用已有实例**时显示。 |

5.  在**配置备份对象**页面，将需要备份的库或者表移动到**已选择数据库对象**框中，单击**下一步**。

    **说明：** 选择备份整个数据库时，将会同时备份权限、存储过程等信息。

6.  在**配置备份时间**页面，配置备份时间等信息，并单击页面右下角的**下一步**。

    |配置|说明|
    |--|--|
    |**全量备份频率**|默认选择单次备份。|
    |**增量日志实时备份**|默认选择开启增量备份。|
    |**增量备份间隔时间**|填写增量备份间隔时间。|
    |**全量备份不标记增量位点**|选择是否开启全量备份标记增量位点。|
    |**不自动删除已备份增量**|选择是否开启自动删除已备份增量。|
    |**开启压缩**|默认选择关闭压缩。|

7.  在**配置生命周期**页面，输入全量备份数据的保存时间和增量备份数据的保存时间。

8.  完成上述配置后，单击页面右下角的**预检查并启动**。

9.  在预检查对话框中显示预检查通过后，单击**立即启动**。

    ![SQLserver预检查](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5132269951/p163728.png)


## 开启迁移

1.  开启迁移任务后，系统会自动创建RDS SQL Server实例并进行全量迁移，请耐心等待。

    ![开启迁移任务1](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5132269951/p163779.png)

2.  全量迁移完成后，系统会进入增量持续迁移阶段，您可以看到**增量日志迁移进度**在不断地推进。

    **说明：** 此时，RDS SQL Server实例为`restoring`状态，不可读写，且其中的数据为上一次增量备份后的数据。

    ![开启迁移任务2](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5132269951/p163781.png)

3.  当您确认可以将业务切换至RDS时，请将线下数据库改为只读状态并记录时刻T0，然后待增量日志迁移进度超过T0时刻后，单击**完成迁移上云**按钮，并等待迁移任务变成**完成**状态。

    **说明：** 在单击**完成迁移上云**按钮后，RDS SQL Server实例为`online`状态，即可正常读写。

    ![开启迁移任务3](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6132269951/p163792.png)


您可以在[RDS管理控制台](https://rds.console.aliyun.com/)中查看新创建的实例。

**说明：** 关于更多RDS SQL Server数据库的介绍，请参见[RDS SQL Server快速入门](~~26140~~)。

