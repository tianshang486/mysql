# 读写分离

读写分离是指通过独享代理地址（读写分离地址）实现读写请求的自动转发。

-   实例为主实例（不是只读实例或灾备实例）。
-   [开通数据库独享代理](/intl.zh-CN/RDS MySQL 数据库/数据库代理（读写分离）/数据库独享代理.md)。
-   [拥有只读实例](/intl.zh-CN/RDS MySQL 数据库/只读实例/创建MySQL只读实例.md)

在对数据库有少量写请求，但有大量读请求的应用场景下，单个实例可能无法承受读取压力，甚至对业务产生影响。为了实现读取能力的弹性扩展，分担数据库压力，您可以创建一个或多个[只读实例](/intl.zh-CN/RDS MySQL 数据库/只读实例/MySQL只读实例简介.md)，利用只读实例满足大量的数据库读取需求。

创建只读实例后，您可以开通读写分离，此时独享代理地址就可以作为读写分离地址，在应用程序中配置独享代理地址，就可以使写请求自动转发到主实例，读请求自动转发到各个只读实例。

![](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4813729951/p34381.png)

## 读写分离地址和内外网地址区别

开通读写分离后，您就可以将独享代理地址配置在应用程序中，客户端发出的请求到达该地址后会根据请求类型和实例权重自动分配给内部的各个实例。

应用程序中的地址如果是主实例的内网或外网地址，则请求只会交给主实例，而不会交给只读实例处理，必须在程序中添加主实例及各个只读实例的地址及权重，才能达到读写分离地址的效果。

## 转发逻辑

-   只发往主实例
    -   所有DML操作（INSERT、UPDATE、DELETE、SELECT FOR UPDATE）。
    -   所有DDL操作（建表/库、删表/库、变更表结构、权限等）。
    -   所有事务中的请求。
    -   用户自定义函数。
    -   存储过程。
    -   EXECUTE语句。
    -   [Multi Statements](https://dev.mysql.com/doc/internals/en/multi-statement.html)。
    -   使用到临时表的请求。
    -   SELECT last\_insert\_id\(\)。
    -   所有对用户变量的查询和更改。
    -   SHOW PROCESSLIST。
    -   KILL（SQL语句中的KILL，非命令KILL）。
-   发往只读实例或主实例
    -   非事务中的读请求。
    -   COM\_STMT\_EXECUTE命令。
-   总是发往所有实例
    -   所有系统变量的更改。
    -   USE命令。
    -   COM\_STMT\_PREPARE命令。
    -   COM\_CHANGE\_USER/COM\_QUIT/COM\_SET\_OPTION等命令。

## 功能优势

-   统一读写分离地址，方便维护。

    不开通读写分离时，您需要在应用程序中分别配置主实例和每个只读实例的连接地址，才能实现将写请求发往主实例而将读请求发往只读实例。

    RDS读写分离功能提供一个独享代理地址，您连接该地址后即可对主实例和只读实例进行读写操作，读写请求被自动转发到对应实例，可降低维护成本。

    同时，您只需添加只读实例的个数，即可不断扩展系统的处理能力，应用程序无需做任何修改。

-   原生链路支持，提升性能，减少维护成本。

    如果您在云上自行搭建代理层实现读写分离，数据在到达数据库之前需要经历多个组件的语句解析和转发，对响应延迟有较大的影响。而RDS读写分离内置在RDS原生生态里，能够有效降低延迟，提升处理速度，同时减少客户的维护成本。

-   可设权重和阈值，符合多场景使用。

    您可以设置主实例和只读实例的读请求权重，以及设置只读实例的延迟阈值。

-   实例健康检查，提升数据库系统的可用性。

    读写分离模块将自动对主实例和只读实例进行健康检查，当发现某个实例出现宕机或者延迟超过阈值时，将不再分配读请求给该实例，读写请求在剩余的健康实例间进行分配。以此确保单个只读实例发生故障时，不会影响应用的正常访问。当实例被修复后，RDS会自动将该实例纳回请求分配体系内。

    **说明：** 为避免单点故障，建议您为一个主实例创建至少两个只读实例。


## 注意事项

-   当主实例或只读实例变更配置时可能会出现连接闪断。
-   新增只读实例后，新建的连接才会被路由到新只读实例上。
-   独享代理地址暂不支持压缩协议。
-   使用独享代理连接地址时，事务请求都会路由到主实例。
-   使用独享代理连接地址进行读写分离时，不保证非事务读的一致性，业务上有读一致性需求可以封装到事务中。
-   使用独享代理连接地址时，`show processlist`会将所有节点的结果合并后返回。
-   如果开通了短连接优化功能，`show processlist`可能会显示闲置的用户连接。
-   如果执行了[Multi-Statements](https://dev.mysql.com/doc/internals/en/multi-statement.html)或存储过程，当前连接的后续请求会全部路由到主节点，需断开当前连接并重新连接才能恢复读写分离。

## 支持的Hint语法

如果使用MySQL命令行进行连接并使用Hint语句，需要在命令中增加`-c`选项，否则Hint会被MySQL命令行工具过滤。

-   支持通过`/*FORCE_MASTER*/`和`/*FORCE_SLAVE*/`指定在主实例或备实例执行查询命令。

    **说明：**

    -   因为Hint的路由优先级最高，例如Hint不受一致性、事务的约束，需要您评估是否可以用于业务。
    -   Hint语句里不能包含改变环境变量的语句，例如`/*FORCE_SLAVE*/ set names utf8;`，可能导致后续业务出错。
-   支持通过`/*force_node='<实例ID>'*/`命令指定在某个实例执行查询命令。例如`/*force_node='rr-bpxxxxx'*/ show processlist;`，该`show processlist;`命令只在rr-bpxxxxx实例执行。如果这个实例发生故障，则返回报错`force hint server node is not found, please check.`。
-   支持通过`/*force_proxy_internal*/set force_node = '<实例ID>';`命令永久指定在某个实例执行查询命令。例如`/*force_proxy_internal*/set force_node = 'rr-bpxxxxx';`，执行该命令后，后续所有命令只发往rr-bpxxxxx实例，如果这个实例发生故障，则返回报错`set force node 'rr-bpxxxxx' is not found, please check.`。

    **说明：** 通常不建议使用`/*force_proxy_internal*/`语法，会导致后续所有请求都发往该实例，读写分离失效。


## 开通读写分离

1.  登录[RDS管理控制台](https://rds.console.aliyun.com/)。

2.  在左侧单击**实例列表**，然后在上方选择实例所在地域。

    ![选择地域](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3074469951/p36543.png)

3.  找到目标实例，单击实例ID。

4.  在左侧导航栏中单击**数据库代理**

5.  选择**读写分离**页签，单击**立即开启**。

6.  设置如下参数。

    ![设置权重](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5126037061/p95288.png)

    |参数|说明|
    |--|--|
    |**延迟阈值**|只读实例同步主实例数据时允许的最长延迟时间。若一个只读实例的延迟时间超过该阈值，则不论该只读实例的权重是多少，读请求都不会转发至该只读实例。 取值范围为0秒到7200秒。受限于SQL的执行情况，只读实例有一定的几率会出现延迟，建议该值不小于30秒。 |
    |**读权重分配**|实例的读权重越高，处理的读请求越多。例如，假设主实例有3个只读实例，读权重分别为0、100、200和200，则表示主实例不处理读请求（写请求仍然自动发往主实例），3个只读实例按照1：2：2的比例处理读请求。     -   **系统分配**：系统根据实例规格自动分配各个实例的读权重。后续该主实例下新增的只读实例也会自动按照系统分配的权重加入到读写分离链路中，无需手动设置。更多信息请参见[系统权重分配规则](/intl.zh-CN/RDS MySQL 数据库/数据库代理（读写分离）/共享代理（下线中）/系统权重分配规则.md)。
    -   **自定义**：手动设置各个实例的读权重，范围为0至10000。后续该主实例下新增只读实例的读权重默认为0，需要您手动修改。
**说明：** 不支持为已经设置[只读实例延时复制](/intl.zh-CN/RDS MySQL 数据库/只读实例/只读实例延时复制.md)时间的实例设置权重。 |

7.  单击**确定**。


开通后，您需要在应用程序中配置读写分离地址（即独享代理地址），就可以使写请求自动转发到主实例，读请求自动转发到各个只读实例。

## 页面介绍

开启数据库独享代理后，您可以在该页面设置读写分离的部分参数，说明如下。

![读写分离地址](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8520057061/p113257.png)

|类别|参数|说明|
|--|--|--|
|**读写分离基本信息**|**读写分离地址**|在应用程序中使用**读写分离地址**，即可实现读写请求的自动转发。**说明：** **代理服务**页面的多个连接地址都是**读写分离地址**，您可以根据访问类型或业务需求配置在不同的应用程序中。 |
|**网络端口**|**读写分离地址**的端口。|
|**地址类型**|**读写分离地址**的地址类型。|
|**延迟阈值**|只读实例同步主实例数据时允许的最长延迟时间。若一个只读实例的延迟时间超过该阈值，则不论该只读实例的权重是多少，读请求都不会转发至该只读实例。|
|**权重分配模式**|分为如下两种模式：-   **系统分配**：系统根据实例规格自动分配各个实例的读权重。后续该主实例下新增的只读实例也会自动按照系统分配的权重加入到读写分离链路中，无需手动设置。更多信息请参见[系统权重分配规则](/intl.zh-CN/RDS MySQL 数据库/数据库代理（读写分离）/共享代理（下线中）/系统权重分配规则.md)。
-   **自定义**：手动设置各个实例的读权重，范围为0至10000。后续该主实例下新增只读实例的读权重默认为0，需要您手动修改。 |
|**参与实例个数**|参与读写分离的主实例和只读实例的总个数。|
|**主实例**|主实例ID。 右侧会显示对应的权重。|
|**只读实例**|只读实例ID。右侧会显示对应的权重。|
|**事务拆分**|**读写分离地址**是否开通了事务拆分功能。详情请参见[事务拆分](/intl.zh-CN/RDS MySQL 数据库/数据库代理（读写分离）/事务拆分.md)。 **说明：** 您可以单击右侧的**开通**或**关闭**按钮开关事务拆分功能。 |
|**读写分离示意图**|无|展示主实例和只读实例的架构以及当前状态。|

## 常见问题

-   主实例写的频率不高，能不能让读请求也发送给主实例？

    设置读权重分配时，为主实例也设置权重即可。

-   读写分离支持hint语句吗？

    您可以通过hint语句强制转发请求到主实例上执行。关于RDS读写分离支持的hint格式，请参见文档[系统权重分配规则](/intl.zh-CN/RDS MySQL 数据库/数据库代理（读写分离）/共享代理（下线中）/系统权重分配规则.md)中的通过hint指定SQL发往主实例或只读实例部分。


## 相关文档

[读写分离常见问题](/intl.zh-CN/RDS MySQL 数据库/数据库代理（读写分离）/共享代理（下线中）/读写分离常见问题.md)

